/*!
  Sqimitive.js - The Frontend Primitive
  Lightweight library to build concrete applications
  Part of Squizzle.me Toolkit  -  http://squizzle.me
  In public domain | by Proger_XP | http://proger.me
  $Id$
*/
;(function(e,t){typeof define=="function"&&define.amd?define(["exports","underscore","jquery"],function(n,r,i){t(e,n,r,i)}):typeof exports!="undefined"?t(e,exports,require("underscore"),require("jquery")):t(e,e.Sqimitive||{},e._,e.$)})(this,function(e,t,n,r){var i=function(e,t){var r=this,i;e&&n.has(e,"constructor")?i=e.constructor:i=function(){return r.apply(this,arguments)},n.extend(i,r,t);var s=function(){this.constructor=i};return s.prototype=r.prototype,i.prototype=new s,e&&n.extend(i.prototype,e),i.__super__=r.prototype,i};e.Sqimitive=t,t.version="1.0";var s=t.Core=function(){this._cid="p"+s.unique("p");for(var e in this)typeof this[e]=="object"&&!(e in this.constructor._shareProps)&&(this[e]=s.deepClone(this[e]))};n.extend(s,{_unique:{},_mergeProps:[],_shareProps:[],extend:function(e,t){var r=i.apply(this,arguments);e||(e={}),r._mergeProps||(r._mergeProps=this._mergeProps),r._shareProps||(r._shareProps=this._shareProps);for(var s=0,o=r._mergeProps.length;s<o;++s){var u=r._mergeProps[s];if(u in e)if(n.isArray(this.prototype[u]))Array.prototype.unshift.apply(r.prototype[u],this.prototype[u]);else for(var a in this.prototype[u])a in r.prototype[u]||(r.prototype[u][a]=this.prototype[u][a])}e=r.prototype;if("events"in e){e._events=n.extend({},e._events);for(var f in e._events)e._events[f]=e._events[f].slice();e.on.call(e,e.events),delete e.events}return r},stub:function(){},unique:function(e){return this._unique[e]=1+(this._unique[e]||0)},picker:function(e,t){return t=s.toArray(t),function(r){if(n.isObject(r)&&e in r)return typeof r[e]=="function"?r[e].apply(r,t):r[e]}},expandFunc:function(e,t){if(typeof e=="string"){var r=e.split(/([.-].*)/);return r.length>1?s.masker(r[0],r[1],t):function(){var n=t||this;return n[e].apply(n,arguments)}}return t?n.bind(e,t):e},masker:function(e,t,r,i){var s=typeof e=="string",o=typeof t=="number"||t==null;return t==null&&(t=1),i||(i=[]),o||(t=t.replace(/\./g,function(e,t){return t>8?"-":t+1}).replace(/[^1-9.\-]+/g,"-").replace(/-+$/,"")),function(){var u=r||this,a=o?i.concat(n.rest(arguments,t)):i.concat();for(var f=0;f<t.length;f++)t[f]!="-"&&a.push(arguments[t[f]-1]);return(s?u[e]:e).apply(u,a)}},deepClone:function(e){if(e&&typeof e=="object")if(n.isArray(e))e=n.map(e.slice(),arguments.callee);else{e=n.extend({},e);for(var t in e)e[t]=arguments.callee(e[t])}return e},parseEvent:function(e){var t=e.match(/^([+\-=]?)([\w\d.:+\-=]+?)(_*)$/);if(!t)throw"Bad event name: "+e;return{prefix:t[1],name:t[2],args:t[3]}},fire:function(e,t){var r;return e&&(t=arguments.length<2?[]:s.toArray(t),n.each(e.concat(),function(e){if("args"in e&&e.args!=t.length)var n=e.sup?e.sup(e.cx||this,t):undefined;else{if(!e.sup&&!e.res)var i=t;else{var i=t.slice();e.sup&&i.unshift(e.sup),e.res&&i.unshift(r)}var n=e.func.apply(e.cx||this,i)}e.ret&&n!==undefined&&(r=n)},this)),r},toArray:function(e){return n.isArguments(e)?Array.prototype.slice.call(e):n.isArray(e)?e:[e]},is$:function(e){return e instanceof r||r.zepto&&r.zepto.isZ(e)}}),n.extend(s.prototype,{_cid:"",_events:{},_eventsByID:{},_eventsByCx:[],_autoOff:[],_logEventID:null,fire:function(e,t){if(this._events.all&&e!="all"){var n=arguments.length<2?[]:s.toArray(t).concat();n.unshift(e);var r=s.fire.call(this,this._events.all,n);if(r!==undefined)return r}return s.fire.call(this,this._events[e],t)},firer:function(e,t,n){return arguments.length>1?(t=s.toArray(t),function(){return(n||this).fire(e,t.concat(Array.prototype.slice.call(arguments)))}):function(){return(n||this).fire(e,arguments)}},logEvents:function(e){if(typeof e=="string"){var t=this._cid;return this.el&&(t+="		"+this.el[0].tagName+".",this.el[0].className&&(t+=(this.el[0].className+"").replace(/ /g,"."))),console.log(e+" ("+(arguments.length-1)+") on "+t),undefined}return!e&&arguments.length?(this.off(this._logEventID),this._logEventID=null):console&&console.log&&!this._logEventID&&(this._logEventID=this.on("all",arguments.callee)),this},on:function(e,t,n){if(typeof e=="object"){for(var r in e){var i=r.split(", ");for(var s=0,o=i.length;s<o;++s)this.fuse(i[s],e[r],t)}return this}if(arguments.length>=2)return this._regHandler(this.fuse(e,t,n));throw"on: Bad arguments"},once:function(e,t,n){if(arguments.length>=2){var r=this.on(e,function(){if(r)return this.off(r),r=null,s.expandFunc(t,this).apply(n||this,arguments)});return r}throw"once: Bad arguments"},autoOff:function(e,t,r){if(arguments.length<1){var i=this._autoOff;return this._autoOff=[],n.invoke(i,"off",this),this}this._autoOff.push(e),arguments.length>2||(r=this);for(var s in t){var o=s.split(", ");for(var u=0,a=o.length;u<a;++u)e.on(o[u],t[s],r)}return e},fuse:function(e,t,r){t=s.expandFunc(t),e=s.parseEvent(e);var i=this._events[e.name]||(this._events[e.name]=[]);this._wrapHandler(e.name);var o={func:t,cx:r,event:e.name};return e.args&&(o.args=e.args.length),e.prefix=="+"?o.res=o.ret=!0:e.prefix=="="&&(o.ret=!0,o.supList=i.splice(0,i.length),o.sup=function(e,t){return n.isArguments(t)&&t[0]===arguments.callee&&(t=Array.prototype.slice.call(t,1)),s.fire.call(e,o.supList,t)}),e.prefix=="-"?i.unshift(o):i.push(o),o},_wrapHandler:function(e){if(this[e]!==s.stub)if(typeof this[e]=="function"&&!this[e]._wrapHandler)this._events[e].unshift({func:this[e],ret:!0});else if(e in this)return;this[e]=this.firer(e),this[e]._wrapHandler=!0},_regHandler:function(e){var t=e.id=e.event+"/"+s.unique("e");return this._eventsByID[t]=e,e.cx&&(this._cxHandlers(e.cx,function(t){t.push(e)})||this._eventsByCx.push([e.cx,e])),t},_cxHandlers:function(e,t){if(e)for(var n=0,r=this._eventsByCx.length;n<r;++n)if(this._eventsByCx[n][0]===e)return t.call(this,this._eventsByCx[n],n)||!0},off:function(e){if(arguments.length<1)throw"off: Bad arguments";return n.isArray(e)?n.each(e,this.off,this):typeof e=="object"?this._cxHandlers(e,function(e,t){n.each(this._eventsByCx.splice(t,1)[0].slice(1),this._unregHandler,this)}):e.indexOf("/")==-1?n.each(this._events[e],this._unregHandler,this):this._unregHandler(this
._eventsByID[e]),this},_unregHandler:function(e){if(e&&e.id){delete this._eventsByID[e.id],e.func=s.stub,this._cxHandlers(e.cx,function(t,n){t.splice(t.indexOf(e),1),t.length||this._eventsByCx.splice(n,1)});var t=(this._events[e.event]||[]).indexOf(e);if(t>=0){var r=[t,1];n.each(e.supList,function(e){e.func===s.stub||r.push(e)}),Array.prototype.splice.apply(this._events[e.event],r)}}}});var o=t.Sqimitive=s.extend({_opt:{},_firingSet:null,_parent:null,_parentKey:null,_children:{},_owning:!0,_childClass:o,_childEvents:[],_respToOpt:{},el:{tag:"div",className:""},elEvents:{},length:0,constructor:function(e){o.__super__.constructor.apply(this,arguments),this.init.apply(this,arguments),this.postInit.apply(this,arguments)},init:function(e){e&&e.el&&(this.el=e.el);if(this.el&&!s.is$(this.el))if(n.isElement(this.el)||typeof this.el=="string")this.el=r(this.el);else{var t=n.omit(this.el,"tag","className");t["class"]=this.el.className||"",this.el=r(document.createElement(this.el.tag||"div")).attr(t).data("sqimitive",this)}if(this.el&&!this.el.length)throw"init: Empty el";for(var i in e)i=="el"||this.set(i,e[i])},postInit:s.stub,render:function(){return this.invoke("attach"),this},attach:function(e){e=arguments.length?r(e):[];if(!e[0]){var t=this.get("attachPath");t&&(e=this._parent?this._parent.$(t):r(t))}e[0]&&e[0]!==this.el[0].parentNode&&(e.append(this.el),this.invoke("attach"));if(this.el){var i=".sqim-"+this._cid;this.el.off(i),n.each(this.elEvents,function(e,t){e=s.expandFunc(e,this),t=t.match(/^\s*(\S+)( .*)?$/),t[1]+=i,t[2]?this.el.on(t[1],t[2],e):this.el.on(t[1],e)},this)}return this},get:function(e){return arguments.length?this._opt[e]:n.clone(this._opt)},set:function(e,t,n){return this.ifSet(e,t,n),this},ifSet:function(e,t,r){r||(r={});var i=this._opt[e],s="normalize_"+e;this[s]&&(t=this[s](t,r)),this._opt[e]=t;if(r.forceFire||!n.isEqual(t,i))return this._fireSet([e,[t,i,r]]),!0},_fireSet:function(e){if(this._firingSet==null){var t=this._firingSet=[e];try{while(e=t.shift())this.fire("change_"+e[0],e[1]),this.fire("change",[e[0]].concat(e[1]));this._firingSet=null}catch(n){throw this._firingSet=null,n}}else this._firingSet.push(e)},nest:function(e,t,n){arguments.length==1&&(t=e,e=this._defaultKey(t));if(e==null||typeof e=="object")throw"nest: bad key given";n||(n={}),e+="";var r=this._children[e];if(t instanceof this._childClass)return r!==t&&(this._owning?(r&&r.unnest(),t.unnest(),this._children[e]=t,t._parent=this,t._parentKey=e):this._children[e]=t,++this.length,this._forward(".",this._childEvents,t),this._owning&&t.owned()),t;throw"nest: Nesting Sqimitive of wrong class"},_defaultKey:function(e){return e._cid},owned:s.stub,_forward:function(e,t,r){return n.each([].concat(t),function(t){var n=e+s.parseEvent(t).name;r.on(t,function(){var e=Array.prototype.slice.call(arguments);return e.unshift(r),this.fire(n,e)},this)},this),r},unlist:function(e){var t;if(typeof e=="object"){for(var n in this._children)if(this._children[n]===e){t=e,e=n;break}}else t=this._children[e+""];return t&&(this._owning?t.remove():(delete this._children[e+""],--this.length,this.unnested(t))),t},unnest:function(){var e=this._parent;return e&&(delete e._children[this._parentKey],this._parent=this._parentKey=null,--e.length,e.unnested(this)),this},unnested:function(e){e.off(this),this.length<0&&console&&console.error&&console.error("Broken nesting: sqimitive.length below zero")},nested:function(e){if(!arguments.length)return n.extend({},this._children);if(e!=null){if(typeof e!="object")return this._children[e+""];for(var t in this._children)if(this._children[t]===e)return e}},slice:function(e,t){return t>0&&(arguments[1]+=e),Array.prototype.slice.apply(n.values(this._children),arguments)},at:function(e){return this.slice(e,1)[0]},remove:function(){return this.el&&this.el.remove(),this.unnest()},assignChildren:function(e,t){t||(t={}),t.assignChildren=!0;var r=t.eqFunc,i=t.keyFunc||this._defaultKey;if(r==null)t.keepMissing||this.each(this.unlist,this);else if(typeof r!="function"){var s=r;r=function(e,t){return t&&e.get(s)==t[s]}}e.data&&(e=e.data),n.isArray(e)||(e=n.values(e));var o=r?n.extend({},this._children):{};for(var u=0;u<e.length;u++){var a=!1;for(var f in o)if(r.call(this,o[f],e[u])){o[f].assignResp(e[u],t),delete o[f],a=!0;break}if(!a){var l=(new this._childClass).assignResp(e[u],t);this.nest(i.call(this,l),l,t)}}return t.keepMissing||n.each(o,this.unlist,this),this},assignResp:function(e,t){t||(t={});for(var n in e){var r=e[n],i=this._respToOpt[n];i===undefined&&(i=!t.onlyDefined),i===!0&&(i=n),typeof i=="function"&&(i=i.call(this,r,n,e,t),r=i[1],i=i[0]),i==0||this.set(i,r,t)}return this},bubble:function(e,t,n){return n&&this[e]&&this[e].apply(this,t),this._parent&&this._parent.bubble(e,t,!0),this},sink:function(e,t,n){return n&&this[e]&&this[e].apply(this,t),this.invoke("sink",e,t,!0),this},$:function(e){return s.is$(e)||n.isElement(e)?r(e):this.el?e==""||e=="."?this.el:this.el.find(e):r()}});o.prototype._childClass=o,o._mergeProps.push("_opt","elEvents"),o._shareProps.push("_childClass");var u=["each","map","reduce","reduceRight","find","filter","reject","every","some","contains","invoke","pluck","where","findWhere","max","min","sortBy","groupBy","indexBy","countBy","keys","pairs","pick","omit","toArray","chain","first","initial","rest","last","without","partition","difference","indexOf","shuffle","sample","lastIndexOf","sortedIndex"],a=u.indexOf("first");n.each(u,function(e){u.indexOf(e)<a?o.prototype[e]=function(){var t=Array.prototype.slice.call(arguments);return t.unshift(this._children),n[e].apply(n,t)}:o.prototype[e]=function(){var t=Array.prototype.slice.call(arguments);return t.unshift(n.values(this._children)),n[e].apply(n,t)}})});
